#!/bin/bash
processes_by_names() { # <list of pnames>
	for pname in "$@"; do
		pgrep "$pname"
	done
}

windows_by_pid() { # <pid>
	pid=$1
	xdotool search --pid "$pid" | while read window_id; do
		window_name="$(xdotool getwindowname $window_id)"
		if [ -z "$window_name" ]; then
			continue
		fi
		echo $window_id
	done
}

windows_by_process_names() { # <list of pnames>
	processes_by_names "$@" | while read pid; do
		windows_by_pid "$pid"
	done
}

bring_to_top() { # <process name(s)>
	windows_by_process_names "$@" | while read window_id; do
		if ! xdotool windowactivate "$window_id" 2>&1 | fgrep -q 'XGetWindowProperty[_NET_WM_DESKTOP] failed (code=1)'; then
			return 0
		fi
	done
	return 1
}

#ulimit -Sm 4000000
#ulimit -Sv 1000000

browser=${firefox_binary:-/usr/bin/iceweasel}
pnames="${firefox_pnames:-iceweasel firefox-esr x-www-browser}"
print "$browser"

for f in "$@"; do
	if [ "${f}" == '--hide' ]; then
		HIDE=true
	elif [ "${f}" == '--activate' ]; then
		ACTIVATE=true
		HIDE=false
	fi
done
[ "$HIDE" != true ] && bring_to_top $pnames

if [ "$ACTIVATE" == true -a "$#" == 1 ]; then
	exit
fi
for f in "$@"; do
	if [ "${f}" == '--hide' ]; then
		continue
	fi
	if [ -f "$f" ]; then
		if echo "$f" | grep -q '[.]url$'; then
			( set -o pipefail;
				grep 'URL' "$1" | sed 's/^URL *= *//'
			) && continue
		fi
	fi
	if [ -f "$f" ]; then
		f="$(python -c 'import sys,pathlib; print(pathlib.Path(sys.argv[1]).resolve().as_uri())' "$f")"
	fi
	echo "${f}" | sed 's/\r//g'
done | xargs -d '\n' $browser --
