#!/bin/bash
message_count() {
	pgrep -x pidgin | while read pid; do
		wmctrl -l -p | grep ${pid} | awk '{print $1}' | while read window; do
			xprop -id ${window} | grep _PIDGIN_UNSEEN_COUNT | awk '{print $NF}'
		done
	done | paste -sd+ | bc
}

set_counter() { # <new value>
	pgrep -x pidgin | while read pid; do
		wmctrl -l -p | grep ${pid} | awk '{print $1}' | while read window; do
			xprop -id ${window} -format _PIDGIN_UNSEEN_COUNT 32c -set _PIDGIN_UNSEEN_COUNT "$1"
		done
	done
}

inc_counter() {
	pgrep -x pidgin | while read pid; do
		wmctrl -l -p | grep ${pid} | awk '{print $1}' | while read window; do
			value=$(xprop -id ${window} | grep _PIDGIN_UNSEEN_COUNT | awk '{print $NF}')
			xprop -id ${window} -format _PIDGIN_UNSEEN_COUNT 32c -set _PIDGIN_UNSEEN_COUNT $((value+1))
		done
	done
}

dec_counter() {
	pgrep -x pidgin | while read pid; do
		wmctrl -l -p | grep ${pid} | awk '{print $1}' | while read window; do
			value=$(xprop -id ${window} | grep _PIDGIN_UNSEEN_COUNT | awk '{print $NF}')
			[ "$value" == 0 ] && continue
			xprop -id ${window} -format _PIDGIN_UNSEEN_COUNT 32c -set _PIDGIN_UNSEEN_COUNT $((value-1))
		done
	done
}

if [ "$1" == "inc" ]; then
	inc_counter
elif [ "$1" == "dec" ]; then
	dec_counter
elif [ "$1" == "reset" ]; then
	set_counter 0
elif [ "$1" == "show" ]; then
	message_count
elif [ -z "$1" ]; then
	messages=$(message_count)
	[ "${messages:-0}" -gt 0 ] && exit 0
	exit 1
else
	echo "Unknown args: $@" >&2
	exit 1
fi
