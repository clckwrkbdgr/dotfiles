#!/bin/sh
# Script for XDG directory support.
# Tries to make XDG-compliant environment.

# Basic XDG structure.
export XDG_CONFIG_HOME=${XDG_CONFIG_HOME:-$HOME/.config}
export XDG_CACHE_HOME=${XDG_CACHE_HOME:-$HOME/.cache}
export XDG_DATA_HOME=${XDG_DATA_HOME:-$HOME/.local/share}

# Fixes for hardcoded homedir dotfiles.
fix_hardcoded_dotfile() {
	homedir_location="$1"
	xdg_location="$2"
	if [ "`readlink "$homedir_location"`" != "$xdg_location" ]; then
		mv -b "$homedir_location" "${homedir_location}.bak"
		ln -s "$xdg_location" "$homedir_location"
	fi
}

# Configurations. Should be stored under VCS.
fix_hardcoded_dotfile ~/.bashrc "$XDG_CONFIG_HOME/bash/bashrc"
fix_hardcoded_dotfile ~/.profile "$XDG_CONFIG_HOME/profile"
fix_hardcoded_dotfile ~/.xinitrc "$XDG_CONFIG_HOME/xinitrc"
export GIMP2_DIRECTORY="$XDG_CONFIG_HOME/gimp"
export MPLAYER_HOME="$XDG_CONFIG_HOME/mplayer"
mocp() { /usr/bin/mocp -C "$XDG_CONFIG_HOME/moc/config" "$@"; }
svn() { /usr/bin/svn --config-dir "$XDG_CONFIG_HOME/subversion" "$@"; }
export VIMPERATOR_INIT=":source $XDG_CONFIG_HOME/vimperator/vimperatorrc"
export VIMPERATOR_RUNTIME="$XDG_CONFIG_HOME/vimperator"
export VIMINIT='let $MYVIMRC="'"$XDG_CONFIG_HOME"'/vim/vimrc" | source $MYVIMRC'
case "$SHELL" in *bash*) eval `dircolors "$XDG_CONFIG_HOME/dir_colors"` ;; esac
export MAILRC=~/.config/mailx/mailrc
dosbox() { /usr/bin/dosbox -conf $XDG_CONFIG_HOME/dosbox/dosbox-0.74.conf -lang $XDG_CONFIG_HOME/dosbox/russian.txt "$@"; }
prboom() { /usr/local/games/prboom-plus -config $XDG_CONFIG_HOME/prboom-plus/prboom-plus.cfg -save $XDG_DATA_HOME/prboom-plus "$@"; }
export PENTADACTYL_RUNTIME=$XDG_CONFIG_HOME/pentadactyl
sylpheed() { /usr/bin/sylpheed --configdir $XDG_CONFIG_HOME/sylpheed-2.0 "$@"; }
export GTK2_RC_FILES="$XDG_CONFIG_HOME/gtk-2.0/gtkrc"
# TODO .w3m : hardcoded
fix_hardcoded_dotfile ~/.w3m "$XDG_CONFIG_HOME/w3m"
export XRE_PROFILE_PATH="$XDG_CONFIG_HOME/firefox"
# TODO .gnome2 : apparently firefox using this?
# TODO .gnome2_private : apparently firefox using this?
# TODO .gstreamer-0.10 : apparently firefox using this???
# TODO .themes : apparently firefox using this?

# Local data. Should be stored in some backup or outer storage.
export WINEPREFIX=/opt/wine-umi
export GNUPGHOME="$XDG_DATA_HOME"/gnupg
# TODO .dropbox : hardcoded
# TODO .dropbox-dist : hardcoded
# TODO .macromedia : WONTFIX - flash player for linux is not supported anymore.
fix_hardcoded_dotfile ~/.macromedia "$XDG_DATA_HOME/macromedia"
# TODO .adobe : WONTFIX - flash player for linux is not supported anymore.
fix_hardcoded_dotfile ~/.adobe "$XDG_DATA_HOME/macromedia"
pidgin() { /usr/bin/pidgin --config=$XDG_DATA_HOME/purple "$@"; }

# These could easily be cleared at any time without loss of any important data.
export LESSHISTFILE="$XDG_CACHE_HOME/less/history"
export RLWRAP_HOME="$XDG_CACHE_HOME/rlwrap_history"
export HISTFILE="$XDG_CACHE_HOME/bash/history"
mkdir -p "$XDG_CACHE_HOME/vim"

# These are valid only for one session and could placed even in RAM.
# TODO .dbus : ~/.config/xfce4/xinitrc will probably handle dbus-launch, how to pass XDG_RUNTIME_DIR to it?
export XAUTHORITY="$XDG_RUNTIME_DIR/Xauthority"
export ICEAUTHORITY="$XDG_RUNTIME_DIR/ICEauthority"

# If supplied, run command in XDG-compliant environment.
[ -n "$1" ] && "$@"

true # To return EXIT_SUCCESS
