#!/bin/bash
# Script for XDG directory support.
# Tries to make XDG-compliant environment.

. ~/.config/xdg/base.sh
. ~/.config/xdg/config.sh
. ~/.config/xdg/data.sh
. ~/.config/xdg/state.sh
. ~/.config/xdg/cache.sh
. ~/.config/xdg/runtime.sh

# Fixes for hardcoded homedir dotfiles.
fix_hardcoded_dotfile() {
	homedir_location="$1"
	xdg_location="$2"
	if [ "`readlink "$homedir_location"`" != "$xdg_location" ]; then
		mv -b "$homedir_location" "${homedir_location}.bak"
		ln -s "$xdg_location" "$homedir_location"
	fi
}

# Configurations. Should be stored under VCS.
fix_hardcoded_dotfile ~/.bashrc "$XDG_CONFIG_HOME/bash/bashrc"
fix_hardcoded_dotfile ~/.profile "$XDG_CONFIG_HOME/profile"
mocp() { /usr/bin/mocp -C "$XDG_CONFIG_HOME/moc/config" "$@"; }
[ -n "$BASH" ] && export -f mocp
svn() { /usr/bin/svn --config-dir "$XDG_CONFIG_HOME/subversion" "$@"; }
[ -n "$BASH" ] && export -f svn
if [ -n "$BASH" ]; then
	if [ "$0" == "bash" ]; then
		case "$SHELL" in *bash*) eval `dircolors "$XDG_CONFIG_HOME/dir_colors"` ;; esac
	fi
fi
dosbox() { /usr/bin/dosbox -conf $XDG_CONFIG_HOME/dosbox/dosbox-0.74.conf "$@"; }
[ -n "$BASH" ] && export -f dosbox
prboom() { /usr/local/games/prboom-plus -config $XDG_CONFIG_HOME/prboom-plus/prboom-plus.cfg -save $XDG_DATA_HOME/prboom-plus "$@"; }
[ -n "$BASH" ] && export -f prboom
sylpheed() { /usr/bin/sylpheed --configdir $XDG_CONFIG_HOME/sylpheed-2.0 "$@"; }
[ -n "$BASH" ] && export -f sylpheed
# TODO .w3m : hardcoded
fix_hardcoded_dotfile ~/.w3m "$XDG_CONFIG_HOME/w3m"
# TODO .mozilla : for some reason ~/.mozilla/{extensions,firefox} are getting recreated on every launch, empty and useless
# TODO .gnome2 : apparently firefox using this?
# TODO .gnome2_private : apparently firefox using this?
# TODO .gstreamer-0.10 : apparently firefox using this???
# TODO .themes : apparently firefox using this?
case "$1" in
	# Exception for freeciv-* clients:
	freeciv-*)
		fix_hardcoded_dotfile "$XDG_CONFIG_HOME/.freeciv/saves" "$XDG_DATA_HOME/freeciv/saves"
		export XDG_HOME=${XDG_HOME:-~/.config}
		;;
esac

# Local data. Should be stored in some backup or outer storage.
export WINEPREFIX=/opt/wine-$USER
# TODO .dropbox : hardcoded
# TODO .dropbox-dist : hardcoded
# TODO .macromedia : WONTFIX - flash player for linux is not supported anymore.
fix_hardcoded_dotfile ~/.macromedia "$XDG_DATA_HOME/macromedia"
# TODO .adobe : WONTFIX - flash player for linux is not supported anymore.
fix_hardcoded_dotfile ~/.adobe "$XDG_DATA_HOME/macromedia"
pidgin() {
	mkdir -p "$XDG_DATA_HOME/purple"
	mkdir -p "$XDG_DATA_HOME/purple/logs"
	mkdir -p "$XDG_CACHE_HOME/purple"
	mkdir -p "$XDG_CACHE_HOME/purple/certificates"
	mkdir -p "$XDG_CACHE_HOME/purple/icons"
	mkdir -p "$XDG_CACHE_HOME/purple/telegram-purple"
	fix_hardcoded_dotfile "$XDG_CONFIG_HOME/purple/logs" "$XDG_DATA_HOME/purple/logs"
	fix_hardcoded_dotfile "$XDG_CONFIG_HOME/purple/accels"        "$XDG_CACHE_HOME/purple/accels"
	fix_hardcoded_dotfile "$XDG_CONFIG_HOME/purple/certificates"  "$XDG_CACHE_HOME/purple/certificates"
	fix_hardcoded_dotfile "$XDG_CONFIG_HOME/purple/icons"         "$XDG_CACHE_HOME/purple/icons"
	fix_hardcoded_dotfile "$XDG_CONFIG_HOME/purple/xmpp-caps.xml" "$XDG_CACHE_HOME/purple/xmpp-caps.xml"
	fix_hardcoded_dotfile "$XDG_CONFIG_HOME/purple/telegram-purple" "$XDG_CACHE_HOME/purple/telegram-purple"
	/usr/bin/pidgin --config=$XDG_CONFIG_HOME/purple "$@";
}
[ -n "$BASH" ] && export -f pidgin

# These could easily be cleared at any time without loss of any important data.
wget() { /usr/bin/wget --hsts-file "$XDG_CACHE_HOME/wget-hsts" "$@"; }
[ -n "$BASH" ] && export -f wget

# These are valid only for one session and could placed even in RAM.
# TODO .dbus : ~/.config/xfce4/xinitrc will probably handle dbus-launch, how to pass XDG_RUNTIME_DIR to it?

# If supplied, run command in XDG-compliant environment.
# If XDG_HOME is set, it substitutes original HOME variable for the command invokation.
if [ -n "$BASH" ]; then
	[ "$0" == "$BASH_SOURCE" -a -n "$1" ] && HOME=${XDG_HOME:-$HOME} "$@"
fi

true # To return EXIT_SUCCESS
