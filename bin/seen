#!/bin/bash

function smart_sort() {
	SORTKEY='lambda line: \
		re.sub(r"/\[[^\]]+\]",r"", \
		re.sub(r"\[([_.0-9]+)[\]}]",r"\1", \
			re.sub(r"([0-9])x([0-9]{2})",r"S0\1E\2", \
				re.sub(r"S0([0-9])E0([0-9]{2})", r"S0\1E\2", \
					line.replace(" ", "_").replace(".", "_") \
				) \
			) \
		) \
		)'
	if [ "x$TEST" != "x" ]; then
		python3 -c 'import sys,re;sortkey='"$SORTKEY"';sys.stdout.write("".join(sorted(map(sortkey, sys.stdin.readlines()))))'
	else
		python3 -c 'import sys,re;sortkey='"$SORTKEY"';sys.stdout.write("".join(sorted(sys.stdin.readlines(), key=sortkey)))'
	fi
}

function get_video_list() {
	grep -v 'sample' | egrep --color=never '(ogm|avi|mkv|mp4|wmv|mpg|mov|m4v)$' | smart_sort
}

if [ "x$TEST" != "x" ]; then
	find -L . | get_video_list
	exit
fi

function list_all_left() {
	find -L . \! -executable | get_video_list
}

if [ "x$1" == "x-l" ]; then
	LIST_ALL=true
	shift
elif [ "x$1" == "x-i" ]; then
	CONFIRM=true
	shift
fi
if [ -n "$1" ]; then
	trap 'popd >/dev/null' EXIT SIGINT SIGTERM SIGHUP
	pushd "$1" >/dev/null || exit 1
	shift
fi

if [ "$LIST_ALL" == true ]; then
	list_all_left
	echo -n 'Series left: '
	list_all_left | wc -l
	exit 0
fi

next=$(list_all_left | head -1)
if [ -z "$next" ]; then
	ls -vRL --color=auto
	echo 'All done.'
	exit 1
fi
yes=y
if [ "$CONFIRM" == true ]; then
	list_all_left
	echo
	echo "${next}, continue?"
	read yes
fi
if [ "$yes" = "y" ]; then
	mplayer $@ "$next" && chmod a+x "$next"
fi
