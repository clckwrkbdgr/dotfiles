import unittest
unittest.defaultTestLoader.testMethodPrefix = 'should'
import textwrap
from .. import pcg as builders
from ..engine.builders import Builder
from .. import monsters
from clckwrkbdgr.math import Point, Size
from clckwrkbdgr.pcg import RNG
from clckwrkbdgr import pcg
from ..engine import items as items_module, appliances as appliances_module

class TestCustomMapLayout(unittest.TestCase):
	def should_generate_map_from_given_custom_layout(self):
		rng = RNG(0)
		builder = builders.CustomMap(rng, """\
				####################
				#........#>##......#
				#........#..#......#
				#....##..##.#......#
				#....#.............#
				#....#.............#
				#........@.........#
				#..................#
				#..................#
				####################
		""")
		builder.generate()
		builder.map_key(**({
			'#':'#',
			'.':'.',
			'start':lambda: 'start',
			'exit':lambda: 'exit',
			}))
		appliances = sorted(builder.make_appliances())
		self.assertEqual(appliances, sorted([
			appliances_module.ObjectAtPos(Point( 9, 6), 'start'),
			appliances_module.ObjectAtPos(Point(10, 1), 'exit'),
			]))
		self.maxDiff = None
		grid = builder.make_grid()
		expected = textwrap.dedent("""\
				####################
				#........#.##......#
				#........#..#......#
				#....##..##.#......#
				#....#.............#
				#....#.............#
				#..................#
				#..................#
				#..................#
				####################
				""")
		self.assertEqual(grid.tostring(), expected)
	def should_generate_map_from_custom_layout_in_class_field(self):
		class _MockCustomMap(builders.CustomMap):
			MAP_DATA = """\
				####################
				#........#>##......#
				#........#..#......#
				#....##..##.#......#
				#....#.............#
				#....#.............#
				#........@.........#
				#..................#
				#..................#
				####################
				"""
			ENTER_TERRAIN = '"'
			EXIT_TERRAIN = '~'
		rng = RNG(0)
		builder = _MockCustomMap(rng, None)
		builder.map_key(**({
			'#':'#',
			'.':'.',
			'"':'"',
			'~':'~',
			'start':lambda: 'start',
			'exit':lambda: 'exit',
			}))
		builder.generate()
		appliances = sorted(builder.make_appliances())
		self.assertEqual(appliances, sorted([
			appliances_module.ObjectAtPos(Point( 9, 6), 'start'),
			appliances_module.ObjectAtPos(Point(10, 1), 'exit'),
			]))
		self.maxDiff = None
		grid = builder.make_grid()
		expected = textwrap.dedent("""\
				####################
				#........#~##......#
				#........#..#......#
				#....##..##.#......#
				#....#.............#
				#....#.............#
				#........".........#
				#..................#
				#..................#
				####################
				""")
		self.assertEqual(grid.tostring(), expected)

class TestRogueDungeon(unittest.TestCase):
	def should_generate_rogue_dungeon(self):
		rng = RNG(1)
		builder = builders.RogueDungeon(rng, Size(80, 25))
		builder.map_key(
				void = ' ',
				wall = '#',
				floor = ".",
				tunnel_floor = ".",
				water = "~",
				corner = "+",
				wall_h = "-",
				wall_v = "|",
				rogue_door = "+",
				rogue_passage = "#",
				start = lambda: 'start',
				exit = lambda: 'exit',
				)
		builder.generate()
		appliances = sorted(builder.make_appliances())
		self.assertEqual(appliances, sorted([
			appliances_module.ObjectAtPos(Point(37, 12), 'start'),
			appliances_module.ObjectAtPos(Point(21, 10), 'exit'),
			]))
		self.maxDiff = None
		grid = builder.make_grid()
		expected = textwrap.dedent("""\
				_                          +----------------------+                            _
				_  +-------------+         |......................| +-------------+            _
				_  |.............+#######  |......................|#+.............|            _
				_  |.............|      ###+......................+#|.............|            _
				_  |.............|         +---------------------++ |.............|            _
				_  +------+------+                               #  +-------------+            _
				_         ##############      ####################                             _
				_                      #      #                                                _
				_                      #      #                       +--------------------+   _
				_              +-------++    ++------------------+    |....................|   _
				_              |........|    |...................+####+....................|   _
				_              |........|    |...................|    |....................|   _
				_              |........|    |...................|    +-----+--------------+   _
				_              |........|    |...................|          ######             _
				_              +---+----+    ++------------------+               #             _
				_              #####          ####################               #             _
				_      +-------+--+               +--------------++   +----------+----------+  _
				_      |..........|               |...............| ##+.....................|  _
				_      |..........|               |...............| # |.....................|  _
				_      |..........|               |...............+## |.....................|  _
				_      |..........|               |...............|   |.....................|  _
				_      |..........|               |...............|   |.....................|  _
				_      +----------+               +---------------+   +---------------------+  _
				_                                                                              _
				_                                                                              _
				""").replace('_', ' ')
		self.assertEqual(grid.tostring(), expected)

class TestBSPDungeon(unittest.TestCase):
	def should_generate_bsp_dungeon(self):
		rng = RNG(0)
		builder = builders.BSPDungeon(rng, Size(80, 25))
		builder.map_key(
				wall = '#',
				floor = ".",
				tunnel_floor = ".",
				water = "~",
				corner = "+",
				wall_h = "-",
				wall_v = "|",
				rogue_door = "+",
				rogue_passage = "#",
				start = lambda: 'start',
				exit = lambda: 'exit',
				)
		builder.generate()
		appliances = sorted(builder.make_appliances())
		self.assertEqual(appliances, sorted([
			appliances_module.ObjectAtPos(Point(31, 20), 'exit'),
			appliances_module.ObjectAtPos(Point(55, 22), 'start'),
			]))
		self.maxDiff = None
		grid = builder.make_grid()
		expected = textwrap.dedent("""\
				################################################################################
				#................#..........#.......#................#.......#............#....#
				#................#..........#.......#................#.......#............#....#
				#................#..........#.......#........................#.................#
				#...........................#........................#.......#............#....#
				#................#..................#................#.......#............#....#
				#................#..........#.......#................#....................#....#
				#................#..........#.......#................#.......#............#....#
				#................#..........#.......#................#.......#............#....#
				####################################################.###########################
				#..............#.....#.............#.....#.......#............#.......#......#.#
				#..............#.....#.............#.....#.......#............#.......#......#.#
				#..............#.....#.............#.....#....................#..............#.#
				#..............#.....#.............#.....#.......#....................#......#.#
				#..............#.....#.............#.............#............#.......#......#.#
				#..............#.........................#.......#............#.......#......#.#
				#....................#.............#.....#.......#............#.......#......#.#
				#..............#.....#.............#.....#.......#............#.......#......#.#
				##########################################.###################################.#
				#...........#.....#........#...............#...........#......#........#.....#.#
				#...........#.....#........#...............#...........#......#........#.......#
				#...........#..............#...............#...........#.....................#.#
				#.................#...........................................#........#.....#.#
				#...........#.....#........#...............#...........#......#........#.....#.#
				################################################################################
				""")
		self.assertEqual(grid.tostring(), expected)

class TestBSPCityBuilder(unittest.TestCase):
	def should_generate_bsp_dungeon(self):
		rng = RNG(0)
		builder = builders.CityBuilder(rng, Size(80, 25))
		builder.map_key(
				wall = '#',
				floor = ".",
				tunnel_floor = ".",
				water = "~",
				corner = "+",
				wall_h = "-",
				wall_v = "|",
				rogue_door = "+",
				rogue_passage = "#",
				start = lambda: 'start',
				exit = lambda: 'exit',
				)
		builder.generate()
		appliances = sorted(builder.make_appliances())
		self.assertEqual(appliances, sorted([
			appliances_module.ObjectAtPos(Point(11,  1), 'start'),
			appliances_module.ObjectAtPos(Point(58, 22), 'exit'),
			]))
		self.maxDiff = None
		grid = builder.make_grid()
		expected = textwrap.dedent("""\
				################################################################################
				#..............................................................................#
				#..............................................................................#
				#..............................................................................#
				#...#########################...############################################...#
				#...#########################...############################################...#
				#...#########################...############################################...#
				#...#########################...############################################...#
				#...#########################...############################################...#
				#...#########################...############################################...#
				#...#########################...############################################...#
				#..............................................................................#
				#..............................................................................#
				#..............................................................................#
				#...###############################...########...#####...############...####...#
				#...###############################...########...#####...############...####...#
				#...###############################...########...#####...############...####...#
				#...###############################...########...#####...############...####...#
				#...###############################...########...#####...############...####...#
				#...###############################...########...#####...############...####...#
				#...###############################...########...#####...############...####...#
				#..............................................................................#
				#..............................................................................#
				#..............................................................................#
				################################################################################
				""")
		self.assertEqual(grid.tostring(), expected)

class TestCaveDungeon(unittest.TestCase):
	def should_generate_cave_dungeon(self):
		rng = RNG(0)
		builder = builders.CaveBuilder(rng, Size(80, 25))
		builder.map_key(
				wall = '#',
				floor = ".",
				tunnel_floor = ".",
				water = "~",
				corner = "+",
				wall_h = "-",
				wall_v = "|",
				rogue_door = "+",
				rogue_passage = "#",
				start = lambda: 'start',
				exit = lambda: 'exit',
				)
		builder.generate()
		appliances = sorted(builder.make_appliances())
		self.assertEqual(appliances, sorted([
			appliances_module.ObjectAtPos(Point( 9, 9), 'start'),
			appliances_module.ObjectAtPos(Point(51, 2), 'exit'),
			]))
		self.maxDiff = None
		grid = builder.make_grid()
		expected = textwrap.dedent("""\
				################################################################################
				########.#######......####..........#.........###########...#.#...............##
				#...###....####................................##...###........................#
				#....####...#..........##......................##..............................#
				#............................#.....#...........................................#
				#..............#............###...###........................##....####........#
				#...........####............##....####...####.......#####.........######......##
				#...........####............##....###...#######....#######........#######.....##
				#...........###...........##.......##...########...................######....###
				##.....................###..............#######...............#....######....###
				####..................####..............####.........................###......##
				####...................#................##....................................##
				#####.............#................##.......................................#.##
				####..............................####......................................#.##
				##......###.........#.#............###.......................##................#
				#.......####........#####.#.##.....####....................####................#
				#.......####........############....###....................###................##
				#.......#####........##########......###..............#.......................##
				#......#####.........#######.........##...##.................................###
				#....#######..........#####..........###..##..................................##
				#...######.............##.................##..................................##
				#....###...............#......##....###...###..................................#
				#............................####.........####.................................#
				##............#####...##....############.#######..###......###................##
				################################################################################
				""")
		self.assertEqual(grid.tostring(), expected)

class TestMazeDungeon(unittest.TestCase):
	def should_generate_maze(self):
		rng = RNG(0)
		builder = builders.MazeBuilder(rng, Size(80, 25))
		builder.map_key(
				wall = '#',
				floor = ".",
				tunnel_floor = ".",
				water = "~",
				corner = "+",
				wall_h = "-",
				wall_v = "|",
				rogue_door = "+",
				rogue_passage = "#",
				start = lambda: 'start',
				exit = lambda: 'exit',
				)
		builder.generate()
		appliances = sorted(builder.make_appliances())
		self.assertEqual(appliances, sorted([
			appliances_module.ObjectAtPos(Point( 7,  4), 'start'),
			appliances_module.ObjectAtPos(Point(25, 20), 'exit'),
			]))
		self.maxDiff = None
		grid = builder.make_grid()
		expected = textwrap.dedent("""\
				################################################################################
				#.#.....#.#.....#.......#...#...#...#...#.....#...#...........#.....#...#...#.##
				#.#.#.#.#.#.###.#.#####.#.#.#.#.#.#.###.#.###.#.###.#########.#.###.###.#.#.#.##
				#...#.#.#.....#.....#.#.#.#.#.#.#.#.#...#...#.......#.........#.#...#...#.#.#.##
				#.#.#.#.###########.#.#.#.#.###.#.#.#.###.#.#######.#.###########.###.###.#.#.##
				#.#.#.#.......#.....#...#.#...#...#.#.....#.#.....#.#...#...#.............#.#.##
				###.#.#######.#.#####.###.###.#.###.#######.#.#####.###.#.###.###.#########.#.##
				#...#.#.#...#.#.....#.#.#.#.#...#.#.....#.#.#.....#.#...#...#.#...#...#.....#.##
				#.#.#.#.#.#.#.#####.#.#.#.#.#.###.#.###.#.#.#####.#.#.#####.#.#####.#.#######.##
				#.#.#.#.#.#.#.......#.#.#.#...#.......#.#.#.#.....#.#.#...#.#.......#.#.......##
				#.#.#.#.#.#.#.#######.#.#.#########.###.#.#.#.#####.#.###.#.#########.#.#####.##
				#.#.#.#.#.#...#.....#.....#.#.....#...#...#.#.....#.#.#...#...#.......#.....#.##
				###.#.#.#.#####.###.#######.#.###.#.#.#####.#####.#.#.#.#.#.#.#.#########.#.####
				#...#...#.#...#.#.......#...#...#.#.#.....#.......#.#.#.#.#.#...#.........#...##
				#.#######.#.###.#.#####.#.#####.###.#####.#.###.###.#.#.#.#.#################.##
				#.#.......#.....#.....#.#.....#.....#...#.#.#.#...#.#.#.#.#.........#...#.#...##
				###.#########.#######.#.###.#.#########.#.#.#.###.#.#.#.###.#######.#.#.#.#.####
				#.#.#.........#.#...#.#...#.#.....#.....#.#.#.....#.#.....#...#...#.#.#.#...#.##
				#.#.###.#######.#.#.#####.#.#####.###.#.#.#.#.#####.#####.#.#.#.###.#.#.#.#.#.##
				#.....#.......#.#.#.....#.#.....#.....#.#.#.#.#...#.....#.#.#.#...#.#.#...#.#.##
				#.###.#######.#.#.###.#.#.#.#############.#.###.#.#####.#.#.#.#.#.#.#.#.###.#.##
				#...#.......#...#.#.#.#.#.#...#...........#...#.#...#...#.#.#.#.#.#...#...#.#.##
				###.###.#.#.#####.#.#.###.###.#.#.#########.#.###.#.#.###.###.#.#.#########.#.##
				#...#...#.#.........#.......#...#...........#.....#.#...#.....#.#.............##
				################################################################################
				""")
		self.assertEqual(grid.tostring(), expected)

class TestSewers(unittest.TestCase):
	def should_generate_sewers_maze(self):
		rng = RNG(0)
		builder = builders.Sewers(rng, Size(80, 25))
		builder.map_key(
				wall = '#',
				floor = ".",
				tunnel_floor = ".",
				water = "~",
				corner = "+",
				wall_h = "-",
				wall_v = "|",
				rogue_door = "+",
				rogue_passage = "#",
				start = lambda: 'start',
				exit = lambda: 'exit',
				)
		builder.generate()
		self.maxDiff = None
		appliances = sorted(builder.make_appliances())
		self.assertEqual(appliances, sorted([
			appliances_module.ObjectAtPos(Point(10, 13), 'start'),
			appliances_module.ObjectAtPos(Point(17, 8), 'exit'),
			]))
		grid = builder.make_grid()
		expected = textwrap.dedent("""\
				################################################################################
				#....................####....####............................................###
				#.~~~~~~~~~~~~~~~~~~.####.~~.####.~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~.###
				#.........~~......~~.####.~~.####.~~......................................~~.###
				#########.~~.####.~~.####.~~.####.~~.####################################.~~.###
				#########.~~.####.~~.####.~~.####.~~.####################################.~~.###
				#########.~~.####.~~.####.~~.####.~~.####################################.~~.###
				#.........~~.####.~~.####.~~......~~.####............................####.~~.###
				#.~~~~~~~~~~.####.~~.####.~~~~~~~~~~.####.~~~~~~~~~~~~~~~~~~~~~~~~~~.####.~~.###
				#.~~.........####.~~.####.........~~.####.~~......................~~.####.~~.###
				#.~~.############.~~.############.~~.####.~~.####################.~~.####.~~.###
				#.~~.############.~~.############.~~.####.~~.####################.~~.####.~~.###
				#.~~.############.~~.############.~~.####.~~.####################.~~.####.~~.###
				#.~~.####.........~~..............~~.####.~~.####............####.~~.####.~~.###
				#.~~.####.~~~~~~~~~~~~~~~~~~~~~~~~~~.####.~~.####.~~~~~~~~~~.####.~~.####.~~.###
				#....####.~~......~~.................####.~~.####.~~.........####.~~.####.~~.###
				#########.~~.####.~~.####################.~~.####.~~.############.~~.####.~~.###
				#########.~~.####.~~.####################.~~.####.~~.############.~~.####.~~.###
				#########.~~.####.~~.####################.~~.####.~~.############.~~.####.~~.###
				#.........~~.####.~~......................~~.####.~~..............~~.####.~~.###
				#.~~~~~~~~~~.####.~~~~~~~~~~~~~~~~~~~~~~~~~~.####.~~~~~~~~~~~~~~~~~~.####.~~.###
				#............####............................####....................####....###
				################################################################################
				################################################################################
				################################################################################
				""")
		self.assertEqual(grid.tostring(), expected)

class TestSquatters(unittest.TestCase):
	def should_populate_dungeon_with_squatters(self):
		rng = RNG(0)
		class _MockSquatters(builders.RogueDungeonSquatters):
			class Mapping:
				rodent = staticmethod(lambda pos,*data: ('rodent',) + data + (pos,))
				plant = staticmethod(lambda pos,*data: ('plant',) + data + (pos,))
				slime = staticmethod(lambda pos,*data: ('slime',) + data + (pos,))
				healing_potion = staticmethod(lambda *data: ('healing potion',) + data)
			MONSTERS = [
					('plant', monsters.Behavior.DUMMY),
					('slime', monsters.Behavior.INERT),
					('rodent', monsters.Behavior.ANGRY),
					]
			ITEMS = [
					('healing_potion',),
					]
			PASSABLE = ('floor',)
		builder = _MockSquatters(rng, Size(80, 25))
		builder.generate()
		settler = builder
		_monsters = list(builder.make_actors())
		_items = list(builder.make_items())

		self.maxDiff = None
		self.assertEqual(sorted(_monsters), sorted([
			('rodent', 3, Point(59, 18)),
			('plant', 1,  Point(68, 12)),
			('rodent', 3, Point(33, 9)),
			('plant', 1,  Point(34, 11)),
			('rodent', 3, Point(9, 19)),
			('plant', 1,  Point(65, 11))
			]))
		self.assertEqual(sorted(_items), sorted([
			items_module.ItemAtPos(Point(31, 19), ('healing potion',)),
			items_module.ItemAtPos(Point(61,  3), ('healing potion',)),
			]))
	def should_populate_dungeon_with_weighted_squatters(self):
		rng = RNG(0)
		class _MockSquatters(builders.RogueDungeonWeightedSquatters):
			class Mapping:
				rodent = staticmethod(lambda pos,*data: ('rodent',) + data + (pos,))
				plant = staticmethod(lambda pos,*data: ('plant',) + data + (pos,))
				slime = staticmethod(lambda pos,*data: ('slime',) + data + (pos,))
				healing_potion = staticmethod(lambda *data: ('healing potion',) + data)
			MONSTERS = [
					(1, ('plant', monsters.Behavior.DUMMY)),
					(5, ('slime', monsters.Behavior.INERT)),
					(10, ('rodent', monsters.Behavior.ANGRY)),
					]
			ITEMS = [
					(1, ('healing_potion',)),
					]
			PASSABLE = ('floor',)
		builder = _MockSquatters(rng, Size(80, 25))
		builder.generate()
		settler = builder
		_monsters = list(builder.make_actors())
		_items = list(builder.make_items())

		self.maxDiff = None
		self.assertEqual(sorted(_monsters), sorted([
			('rodent', 3, Point(59, 18)),
			('slime', 2,  Point(68, 12)),
			('rodent', 3, Point(33, 9)),
			('slime', 2,  Point(34, 11)),
			('rodent', 3, Point(9, 19)),
			('slime', 2,  Point(65, 11))
			]))
		self.assertEqual(sorted(_items), sorted([
			items_module.ItemAtPos(Point(61, 3), ('healing potion',)),
			items_module.ItemAtPos(Point(63, 4), ('healing potion',)),
			]))
