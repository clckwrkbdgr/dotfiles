<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<script type="application/javascript" src="../unittest.js"></script>
	<script type="application/javascript" src="../utils.js"></script>
	<script type="application/javascript" src="../autoidle.js"></script>
</head>
<body onload="clckwrkbdgr.unittest.run('should_')">
	<noscript>
		Failed: Javascript is needed to be turned ON to test Javascript functionality!
	</noscript>
	<div id="unittest-main">
	</div>

	<div id="test-area">
	</div>

<script type="application/javascript">
try {
	console.log('Creating manual testing layout...');

	// UI.
	var test_area = document.querySelector('#test-area');

	// Checkbox to emulate trigger.
	var buy_trigger = document.createElement('input');
	buy_trigger.setAttribute('type', 'checkbox');
	buy_trigger.setAttribute('id', 'test-buy-trigger');
	buy_trigger.setAttribute('name', 'test-buy-trigger');
	test_area.appendChild(buy_trigger);

	var buy_trigger_label = document.createElement('label');
	buy_trigger_label.setAttribute('for', 'test-buy-trigger');
	buy_trigger_label.innerText = 'Trigger buying';
	test_area.appendChild(buy_trigger_label);

	// Text field to emulate string-parameter trigger.
	var name_trigger = document.createElement('input');
	name_trigger.setAttribute('type', 'text');
	name_trigger.setAttribute('id', 'test-name-trigger');
	name_trigger.setAttribute('name', 'test-name-trigger');
	test_area.appendChild(name_trigger);

	var name_trigger_label = document.createElement('label');
	name_trigger_label.setAttribute('for', 'test-name-trigger');
	name_trigger_label.innerText = 'Trigger name';
	test_area.appendChild(name_trigger_label);

	// Console.
	var text_output = document.createElement('div');
	text_output.setAttribute('id', 'test-text-output');
	text_output.style['white-space'] = 'pre-wrap';
	text_output.style['border'] = '1px dashed black';
	test_area.appendChild(text_output);

	// Rules.
	function need_to_buy()
	{
		return document.querySelector('#test-buy-trigger').checked;
	}
	function have_name()
	{
		return document.querySelector('#test-name-trigger').value;
	}
	function autobuy_thing()
	{
		document.querySelector('#test-text-output').innerText += '\n' + 'Auto-bought thing.';
		document.querySelector('#test-buy-trigger').checked = false;
	}
	function autoname_thing()
	{
		document.querySelector('#test-text-output').innerText += '\n' + 'Auto-named thing.';
		document.querySelector('#test-name-trigger').value = "";
	}

	// Init.
	clckwrkbdgr.autoidle.install('#test-area', {
		delay_start: function(callback) { setTimeout(callback, 1000); },
	});
	clckwrkbdgr.autoidle.setup_trigger("Need to buy", need_to_buy);
	clckwrkbdgr.autoidle.setup_trigger("Have name", have_name, "string");
	clckwrkbdgr.autoidle.setup_action("Buy thing", autobuy_thing);
	clckwrkbdgr.autoidle.setup_action("Name thing", autoname_thing);
	clckwrkbdgr.autoidle.add_rule(["Need to buy"], "Buy thing");
	clckwrkbdgr.autoidle.add_rule([
		["Have name", "equal", "name"],
	], "Name thing");
} catch(e) {
	console.error(e);
}
</script>

<script type="application/javascript">
var unittest = clckwrkbdgr.unittest;
var mock = {};

function setUp()
{
	unittest.assertTrue(window.clckwrkbdgr);
	unittest.assertTrue(window.clckwrkbdgr.autoidle);

	mock.autoidle = {
		_triggers_registry:{},
		_actions_registry:{},
		_rules:[],
		_enable_all:true,
	};
	mock.action_log = [];
	mock.default_trigger = function() { return true; }
	mock.default_action = function() { mock.action_log.push('acted'); }
}

function should_check_rules()
{
	clckwrkbdgr.autoidle.setup_trigger("Mock Trigger", mock.default_trigger, {autoidle:mock.autoidle});
	clckwrkbdgr.autoidle.setup_action("Mock Action", mock.default_action, {autoidle:mock.autoidle});
	clckwrkbdgr.autoidle.add_rule(["Mock Trigger"], "Mock Action", {autoidle:mock.autoidle});

	clckwrkbdgr.autoidle._check_rules({autoidle:mock.autoidle});

	unittest.assertEqual(mock.action_log, ['acted']);
}

function should_not_check_rules_when_disabled_all()
{
	mock.autoidle._enable_all = false;
	clckwrkbdgr.autoidle.setup_trigger("Mock Trigger", mock.default_trigger, {autoidle:mock.autoidle});
	clckwrkbdgr.autoidle.setup_action("Mock Action", mock.default_action, {autoidle:mock.autoidle});
	clckwrkbdgr.autoidle.add_rule(["Mock Trigger"], "Mock Action", {autoidle:mock.autoidle});

	clckwrkbdgr.autoidle._check_rules({autoidle:mock.autoidle});

	unittest.assertEqual(mock.action_log, []);
}

function should_run_action_only_when_all_triggers_are_fired()
{
	var triggers = [false, false];
	function mock_trigger_a() { return triggers[0]; }
	function mock_trigger_b() { return triggers[1]; }

	clckwrkbdgr.autoidle.setup_trigger("Mock Trigger A", mock_trigger_a, {autoidle:mock.autoidle});
	clckwrkbdgr.autoidle.setup_trigger("Mock Trigger B", mock_trigger_b, {autoidle:mock.autoidle});
	clckwrkbdgr.autoidle.setup_action("Mock Action", mock.default_action, {autoidle:mock.autoidle});
	clckwrkbdgr.autoidle.add_rule(["Mock Trigger A", "Mock Trigger B"], "Mock Action", {autoidle:mock.autoidle});

	clckwrkbdgr.autoidle._check_rules({autoidle:mock.autoidle});
	unittest.assertEqual(mock.action_log, []);

	triggers[0] = true;
	clckwrkbdgr.autoidle._check_rules({autoidle:mock.autoidle});
	unittest.assertEqual(mock.action_log, []);

	triggers[1] = true;
	clckwrkbdgr.autoidle._check_rules({autoidle:mock.autoidle});
	unittest.assertEqual(mock.action_log, ['acted']);
}

function should_ignore_undefined_triggers()
{
	mock.autoidle._enable_all = false;
	clckwrkbdgr.autoidle.setup_trigger("Mock Trigger", mock.default_trigger, {autoidle:mock.autoidle});
	clckwrkbdgr.autoidle.setup_action("Mock Action", mock.default_action, {autoidle:mock.autoidle});
	clckwrkbdgr.autoidle.add_rule(["Undefined Trigger"], "Mock Action", {autoidle:mock.autoidle});

	clckwrkbdgr.autoidle._check_rules({autoidle:mock.autoidle});
	unittest.assertEqual(mock.action_log, []);
}

function should_ignore_undefined_actions()
{
	mock.autoidle._enable_all = false;
	clckwrkbdgr.autoidle.setup_trigger("Mock Trigger", mock.default_trigger, {autoidle:mock.autoidle});
	clckwrkbdgr.autoidle.setup_action("Mock Action", mock.default_action, {autoidle:mock.autoidle});
	clckwrkbdgr.autoidle.add_rule(["Mock Trigger"], "Undefined Action", {autoidle:mock.autoidle});

	clckwrkbdgr.autoidle._check_rules({autoidle:mock.autoidle});
	unittest.assertEqual(mock.action_log, []);
}

function should_run_have_triggers_with_parameters()
{
	var trigger_value = "none";
	function mock_trigger_str() { return trigger_value; }

	clckwrkbdgr.autoidle.setup_trigger("Mock Trigger String", mock_trigger_str,
		"string",
		{autoidle:mock.autoidle});
	clckwrkbdgr.autoidle.setup_action("Mock Action", mock.default_action, {autoidle:mock.autoidle});
	clckwrkbdgr.autoidle.add_rule([
		["Mock Trigger String", "equal", "two"],
	], "Mock Action", {autoidle:mock.autoidle});

	clckwrkbdgr.autoidle._check_rules({autoidle:mock.autoidle});
	unittest.assertEqual(mock.action_log, []);

	trigger_value = "one";
	clckwrkbdgr.autoidle._check_rules({autoidle:mock.autoidle});
	unittest.assertEqual(mock.action_log, []);

	trigger_value = "two";
	clckwrkbdgr.autoidle._check_rules({autoidle:mock.autoidle});
	unittest.assertEqual(mock.action_log, ['acted']);
}

</script>

</body>
</html>
